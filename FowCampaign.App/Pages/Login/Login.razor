@page "/login"
@page "/"
@using System.Net
@using System.Net.Http.Json
@using FowCampaign.App.DTO
@using FowCampaign.App.Shared
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject LoginDto User

<div class="container">
    <PaperSheet @ref="_paper">
        <div class="signInPanel">

            <div class="title">
                TOP SECRET
            </div>

            <div class="login">

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="error-box">
                        ⚠ @_errorMessage
                    </div>
                }

                <div class="data-box">
                    <input type="text" @bind="User.Username" @onkeydown="Enter" placeholder="CODENAME" required/>
                    <label> USERNAME </label>
                </div>

                <div class="data-box">
                    <input type="password" @bind="User.Password" @onkeydown="Enter" placeholder="******" required/>
                    <label> PASSWORD </label>
                </div>

                <br/>

                <div class="data-box">
                    <button class="logButton" @onclick="HandleUserLogin">
                        IDENTIFY (LOG IN)
                    </button>
                </div>

                <div class="data-box">
                    <button class="logButton"
                            style="background-color: var(--wood-light); font-size: 0.9rem;"
                            @onclick="ShowSignUpPage">
                        REQUEST CLEARANCE (SIGN UP)
                    </button>
                </div>

            </div>
        </div>
    </PaperSheet>
</div>

<style>
    .error-box {
        color: #d32f2f;
        background-color: #fdecea;
        border: 1px solid #d32f2f;
        padding: 10px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
        font-size: 0.9rem;
        border-radius: 4px;
        text-transform: uppercase;
    }
</style>

@code {
    private PaperSheet _paper;
    private string _errorMessage = "";

    [Parameter] public string UserName { get; set; }

    private async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code is "Enter" or "NumpadEnter")
        {
            await HandleUserLogin();
        }
    }

    private async Task HandleUserLogin()
    {
        _errorMessage = "";

        if (string.IsNullOrWhiteSpace(User.Username) || string.IsNullOrWhiteSpace(User.Password))
        {
            _errorMessage = "Codename and Password are required.";
            return;
        }

        try 
        {
            var response = await Http.PostAsJsonAsync("api/User/login", User);

            if (response.IsSuccessStatusCode)
            {
                await _paper.TossAndNavigate("/home");
            }
            else if (response.StatusCode == HttpStatusCode.NotFound)
            {
                ShowSignUpPage();
            }
            else if (response.StatusCode == HttpStatusCode.Unauthorized)
            {
                _errorMessage = "Access Denied: Invalid Credentials.";
            }
            else
            {
                _errorMessage = "Communication Error. Secure line failed.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Network unavailable.";
            Console.WriteLine(ex.Message);
        }
    }

    private async Task ShowSignUpPage()
    {
        await _paper.TossAndNavigate("/register");
    }
}