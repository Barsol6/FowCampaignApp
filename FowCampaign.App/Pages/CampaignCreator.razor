@using System.Net.Http.Headers
@using System.Text.Json
@using FowCampaign.App.DTO
@using FowCampaign.App.Layout
@using FowCampaign.App.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.WebAssembly.Http
@using Microsoft.JSInterop

@page "/campaigncreator"

@attribute [Authorize]
@layout HomeLayout

@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

<PaperSheet @ref="_paper">
    
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button @onclick="GoBack" style="background:none; border:none; cursor:pointer; font-weight:bold; font-family:'Courier New'; font-size:1.2rem; color:#8b0000;">
            &lt; ABORT SETUP
        </button>

        <h2 style="font-family: 'Black Ops One'; margin: 0; color: #333;">
            CAMPAIGN SETUP
        </h2>
        
        <div style="width: 150px;"></div>
    </div>

    <div class="paper-form" style="border: none; box-shadow: none; padding: 0;">
        <div style="display: flex; gap: 20px; align-items: center; justify-content: center; margin-bottom: 20px;">
            <input type="text" class="tactical-input" @bind="_model.Name" placeholder="Operation Codename" />
            
            <label class="logButton" style="padding: 10px 20px;">
                @(_hasMap ? "CHANGE MAP" : "UPLOAD MAP")
                <InputFile OnChange="HandleImageUpload" style="display: none;" accept="image/*" />
            </label>

            <button class="logButton" @onclick="SaveCampaign" disabled="@(!IsReadyToSave)">
                CONFIRM & DEPLOY
            </button>
        </div>
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div style="color:red; text-align:center; font-weight:bold;">@_errorMessage</div>
        }
    </div>

    @if (_hasMap)
    {
        <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 20px;">
            
            <div style="flex: 2;">
                <div class="canvas-wrapper">
                    <canvas id="mapCanvas" @onclick="HandleCanvasClick"></canvas>
                </div>
                <div style="text-align: center; margin-top: 5px;">
                    <button @onclick="ResetMap" style="color: #d32f2f; background: none; border: none; font-weight: bold; cursor: pointer;">
                        [RESET MAP]
                    </button>
                </div>
            </div>

            <div class="paper-form" style="flex: 1; min-width: 300px;">
                <h4 style="border-bottom: 2px solid #333; padding-bottom: 5px;">FACTIONS</h4>
                
                @foreach (var faction in _model.Factions)
                {
                    <div style="background: rgba(255,255,255,0.5); padding: 10px; margin-bottom: 10px; border: 1px solid #999;">
                        
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom: 5px;">
                            <div style="width:25px; height:25px; background:@faction.Color; border:2px solid @(_selectedFaction == faction ? "#000" : "#999"); cursor: pointer;" 
                                 @onclick="() => _selectedFaction = faction">
                            </div>
                            
                            <input @bind="faction.Name" style="border:none; background:transparent; font-weight:bold; font-size: 1.1rem; width: 100%;" />
                        </div>

                        <label style="font-size: 0.8rem; display: block; cursor: pointer; margin-top: 5px;">
                            <input type="radio" name="myFaction" 
                                   checked="@(_myFaction == faction)"
                                   @onchange="() => _myFaction = faction" />
                            COMMAND THIS FACTION
                        </label>
                    </div>
                }
                
            </div>
        </div>
    }
</PaperSheet>


@code {
    private PaperSheet _paper;
    private CreateCampaignDto _model = new();
    private FactionDto _selectedFaction;
    private FactionDto _myFaction;
    private List<ZoneSeedDto> _recordedZones = new();


    private string _imageDataUrl;
    private bool _hasMap = false;
    private byte[] _fileBytes;
    private string _fileContentType;
    private string _errorMessage;
    private bool _shouldRenderMap = false;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldRenderMap)
        {
            _shouldRenderMap = false;
            await JsRuntime.InvokeVoidAsync("mapTools.initMap", "mapCanvas", _imageDataUrl);
        }
    }
    
    protected override void OnInitialized() 
    { 
        AddAxis(); 
        AddAllies(); 
    }
    private void AddAxis() 
    { 
        var f = new FactionDto { Name = "Axis", Color = "#bd2424" }; 
        _model.Factions.Add(f); 
        _selectedFaction = f; 
    }
    private void AddAllies() 
    { 
        var f = new FactionDto { Name = "Allies", Color = "#2980b9" }; 
        _model.Factions.Add(f); 
    }

    private bool IsReadyToSave => !string.IsNullOrEmpty(_model.Name) && _hasMap && _myFaction != null;

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        _fileContentType = file.ContentType;
        var resizedFile = await file.RequestImageFileAsync("image/png", 1280, 720);

        _fileBytes = new byte[resizedFile.Size];
        await resizedFile.OpenReadStream(maxAllowedSize: 1024 * 1024 * 10).ReadAsync(_fileBytes);

        var base64 = Convert.ToBase64String(_fileBytes);
        _imageDataUrl = $"data:image/png;base64,{base64}";
        _hasMap = true;
  
        _shouldRenderMap = true;
    }

    private async Task HandleCanvasClick(MouseEventArgs e)
    {
        if (_selectedFaction == null) return;
        await JsRuntime.InvokeVoidAsync("mapTools.floodFill", (int)e.OffsetX, (int)e.OffsetY, _selectedFaction.Color);
        _recordedZones.Add(new ZoneSeedDto { X = e.OffsetX, Y = e.OffsetY, FactionName = _selectedFaction.Name });
    }

    private async Task ResetMap()
    {
        await JsRuntime.InvokeVoidAsync("mapTools.resetMap");
    }
    
    private async Task SaveCampaign()
    {
        if (_myFaction == null)
        {
            _errorMessage = "You must select a faction to command!";
            return;
        }

        var gameState = new GameStateDto
        {
            Factions = _model.Factions,
            Zones = _recordedZones
        };

        var jsonString = JsonSerializer.Serialize(gameState);
        
        using var content = new MultipartFormDataContent();
        content.Add(new StringContent(_model.Name), "Name");
        content.Add(new StringContent(jsonString), "GameStateJson");
        content.Add(new StringContent(_myFaction.Name), "CreatorFactionName");

        var imgContent = new ByteArrayContent(_fileBytes);
        imgContent.Headers.ContentType = new MediaTypeHeaderValue(_fileContentType);
        content.Add(imgContent, "MapImage", "map.png");

        var request = new HttpRequestMessage(HttpMethod.Post, "api/Campaign");
        request.Content = content;
        request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);
        var response = await Http.SendAsync(request);
        
        if (response.IsSuccessStatusCode)
        {
            await _paper.TossAndNavigate("/home", forceLoad: true);
        }
        else
        {
            _errorMessage = "Deployment Failed. Check server logs.";
            Console.WriteLine(response);
        }
        
      
    }
    
    private async void GoBack()
    {
        await _paper.TossAndNavigate("/home", forceLoad: true);
    }
    
}