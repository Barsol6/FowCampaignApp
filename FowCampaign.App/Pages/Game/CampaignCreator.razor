@page "/campaigncreator"
@using System.Net.Http.Headers
@using System.Text.Json
@using FowCampaign.App.DTO
@using FowCampaign.App.Layout
@using FowCampaign.App.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.WebAssembly.Http
@using Microsoft.JSInterop

@attribute [Authorize]
@layout HomeLayout

@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

<PaperSheet @ref="_paper">

    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button @onclick="GoBack"
                style="background:none; border:none; cursor:pointer; font-weight:bold; font-family:'Courier New'; font-size:1.2rem; color:#8b0000;">
            &lt; ABORT SETUP
        </button>

        <h2 style="font-family: 'Black Ops One'; margin: 0; color: #333;">
            CAMPAIGN SETUP
        </h2>

        <div style="width: 150px;"></div>
    </div>

    <div class="paper-form" style="border: none; box-shadow: none; padding: 0;">
        <div style="display: flex; gap: 20px; align-items: center; justify-content: center; margin-bottom: 20px;">
            <input type="text" class="tactical-input" @bind="_model.Name" placeholder="Operation Codename"/>

            <label class="logButton" style="padding: 10px 20px;">
                @(_hasMap ? "CHANGE MAP" : "UPLOAD MAP")
                <InputFile OnChange="HandleImageUpload" style="display: none;" accept="image/*"/>
            </label>

            <button class="logButton" @onclick="SaveCampaign" disabled="@(MissingRequirements.Any())">
                CONFIRM & DEPLOY
            </button>
        </div>

        @if (MissingRequirements.Any())
        {
            <div style="margin-bottom: 20px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-left: 5px solid #ffc107; color: #856404; font-family: 'Courier New'; font-size: 0.9rem;">
                <strong>DEPLOYMENT HALTED - MISSING INTEL:</strong>
                <ul style="margin: 5px 0 0 20px; padding: 0;">
                    @foreach (var req in MissingRequirements)
                    {
                        <li>@req</li>
                    }
                </ul>
            </div>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div style="color:red; text-align:center; font-weight:bold; margin-bottom: 10px;">@_errorMessage</div>
        }
    </div>

    @if (_hasMap)
    {
        <div class="paper-form"
             style="margin-bottom: 15px; border: 1px dashed #555; background-color: #fcf8e3; padding: 10px;">
            <h4 style="margin-top:0;">UNIT CREATOR</h4>
            <input type="text" class="tactical-input" @bind="_unitName" style="padding-bottom: 5px;"
                   placeholder="Unit Name"/>
            <div style="display:flex; gap: 20px; align-items: flex-start;">
                <label class="logButton" style="font-size: 0.7rem; padding: 5px;">
                    + NEW Unit
                    <InputFile OnChange="@HandleIconUnitUpload" style="display: none;" accept="image/*"/>
                </label>

                @foreach (var def in _unitDefinitions)
                {
                    <div @onclick="() => _selectedDefinitionId = def.Id"
                         style="cursor: pointer; padding: 5px; border: 2px solid @(_selectedDefinitionId == def.Id ? "#bd2424" : "transparent");">
                        <img src="@def.ImageBase64" style="width: 32px; height: 32px; display: block; margin: 0 auto;"/>
                        <input @bind="def.Name"
                               style="width: 80px; border: none; background: transparent; text-align: center; font-size: 0.8rem;"/>
                    </div>
                }
            </div>
        </div>
        <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 20px;">

            <div style="flex: 2;">
                <div
                    style="background: #ddd; padding: 5px; margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <button style="@(_currentTool == "PAINT" ? "background:#333; color:white;" : "")"
                            @onclick='() => _currentTool = "PAINT"'>
                        PAINT
                    </button>
                    <button style="@(_currentTool == "DEPLOY" ? "background:#333; color:white;" : "")"
                            @onclick='() => _currentTool = "DEPLOY"'>
                        DEPLOY
                    </button>

                    @if (_currentTool == "DEPLOY")
                    {
                        <span style="font-size:0.8rem;">Select Unit Type above ↑</span>
                        <button
                            @onclick="() => { if(_deployedUnits.Any()) _deployedUnits.RemoveAt(_deployedUnits.Count - 1); }"
                            style="margin-left:auto; color:red;">
                            UNDO
                        </button>
                    }
                </div>
                <div class="canvas-wrapper"
                     style="position: relative; width: fit-content; margin: 0 auto; display: block; "
                     @onmousemove="HandleWrapperMouseMove"
                     @onmouseup="HandleWrapperMouseUp">
                    <canvas id="mapCanvas" @onclick="HandleCanvasClick" style="display: block; "></canvas>
                    @foreach (var unit in _deployedUnits)
                    {
                        var factionColor = _model.Factions.FirstOrDefault(f => f.Name == unit.FactionName)?.Color ?? "#000";
                        var def = _unitDefinitions.FirstOrDefault(d => d.Id == unit.DefinitionId);
                        var isBeingDragged = _draggingUnit == unit;

                        if (def != null)
                        {
                            <div class="map-unit @(isBeingDragged ? "is-dragging" : "")"
                                 style="position: absolute;
                                     left: @(unit.X)px;
                                 top: @(unit.Y)px;
                                 transform: translate(-50%, -50%);
                                 border: 2px solid @factionColor;
                                 box-shadow: 0 0 5px @factionColor;
                                 pointer-events: @(isBeingDragged ? "none" : "auto");"
                                 @onmousedown="() => StartDrag(unit)"
                                 @onmousedown:stopPropagation="true"
                                 @oncontextmenu="() => DeleteUnit(unit)"
                                 @oncontextmenu:preventDefault="true">

                                <img src="@def.ImageBase64" style="width: 100%; height: 100%; object-fit: contain;"/>
                            </div>
                        }
                    }
                </div>
                <div style="text-align: center; margin-top: 5px;">
                    <button @onclick="ResetMap"
                            style="color: #d32f2f; background: none; border: none; font-weight: bold; cursor: pointer;">
                        [RESET MAP]
                    </button>
                </div>
            </div>

            <div class="paper-form faction-dossier-panel" style="flex: 1; min-width: 350px;">

                <div class="new-faction-row">
                    <input type="color" class="color-picker-chip" @bind="_factionColor" title="Faction Color"/>
                    <input class="input-military" @bind="_factionName" placeholder="NEW FACTION NAME..."/>

                    <button class="logButton" style="width: auto; padding: 10px; font-size: 0.9rem;"
                            @onclick="AddFaction">
                        ADD
                    </button>
                </div>

                <div style="max-height: 500px; overflow-y: auto; padding: 5px;">
                    @foreach (var faction in _model.Factions)
                    {
                        <div class="faction-card" style="border-left: 5px solid @faction.Color;">

                            <div class="faction-header-row">
                                <div style="width:25px; height:25px; background:@faction.Color;
                                border:2px solid @(_selectedFaction == faction ? "#000" : "#ddd");
                                box-shadow: @(_selectedFaction == faction ? "0 0 5px #000" : "none");
                                cursor: pointer;"
                                     @onclick="() => _selectedFaction = faction"
                                     title="Select to Paint">
                                </div>

                                <input @bind="faction.Name"
                                       style="border:none; background:transparent; font-weight:bold; 
                                  font-family: 'Black Ops One'; font-size: 1.1rem; width: 100%; color: #333;"/>

                                <button class="btn-card-delete"
                                        @onclick="() => { 
                                        _model.Factions.Remove(faction);
                                        _deployedUnits.RemoveAll(u => u.FactionName == faction.Name);
                                        _recordedZones.RemoveAll(z => z.FactionName == faction.Name);
                                    }" title="Scrap Faction">
                                    &times;
                                </button>
                            </div>

                            <div class="faction-options-row">

                                <label>
                                    <input type="checkbox" class="hidden-checkbox"
                                           checked="@(_myFaction == faction)"
                                           @onchange="() => _myFaction = faction"/>
                                    <div class="stamp-option stamp-commander">
                                        <div class="stamp-badge"></div>
                                        <span>COMMAND</span>
                                    </div>
                                </label>

                                <label>
                                    <input type="checkbox" class="hidden-checkbox"
                                           checked="@(_startingFaction == faction)"
                                           @onchange="() => _startingFaction = faction"/>
                                    <div class="stamp-option stamp-starter">
                                        <div class="stamp-badge"></div>
                                        <span>1ST TURN</span>
                                    </div>
                                </label>

                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    @if (_isScanning)
    {
        <div
            style="position:fixed; top:20px; right:20px; background:rgba(0,0,0,0.8); color:white; padding:10px; border-radius:5px; z-index:9999;">
            Running Intel Scan ...
        </div>
    }
</PaperSheet>

@code {
    private PaperSheet _paper;
    private readonly CreateCampaignDto _model = new();
    private FactionDto _selectedFaction;
    private FactionDto _myFaction;
    private FactionDto _startingFaction;
    private readonly List<ZoneSeedDto> _recordedZones = new();
    private readonly List<UnitDefinitionDto> _unitDefinitions = new();
    private readonly List<UnitDto> _deployedUnits = new();
    private UnitDto _draggingUnit;
    private List<DetectedLabelDto> _ocrLabels = new();

    private string _unitName = string.Empty;
    private string _currentTool = "PAINT";
    private string _selectedDefinitionId;
    private string _imageDataUrl;
    private bool _hasMap;
    private bool _isScanning;
    private byte[] _fileBytes;
    private string _fileContentType;
    private string _errorMessage;
    private string _regionName = string.Empty;
    private string _factionName = string.Empty;
    private string _factionColor = "#000000";

    private bool _shouldRenderMap;

    private List<string> MissingRequirements
    {
        get
        {
            var list = new List<string>();
            if (string.IsNullOrWhiteSpace(_model.Name)) list.Add("Operation Codename is missing.");
            if (!_hasMap) list.Add("Tactical Map must be uploaded.");
            if (_model.Factions.Count < 2) list.Add($"At least 2 Factions required (Current: {_model.Factions.Count}).");
            if (_myFaction == null) list.Add("Select your Faction to COMMAND (Checkbox).");
            if (_startingFaction == null) list.Add("Select Faction for 1ST TURN (Checkbox).");
            return list;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldRenderMap)
        {
            _shouldRenderMap = false;
            await JsRuntime.InvokeVoidAsync("mapTools.initMap", "mapCanvas", _imageDataUrl);
        }
    }
    
    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        _fileContentType = file.ContentType;
        long maxFileSize = 1024 * 1024 * 20;

        try
        {
            _fileBytes = new byte[file.Size];
            await file.OpenReadStream(maxFileSize).ReadAsync(_fileBytes);

            var base64 = Convert.ToBase64String(_fileBytes);
            _imageDataUrl = $"data:{_fileContentType};base64,{base64}";

            _hasMap = true;
            _shouldRenderMap = true;

            _isScanning = true;
            StateHasChanged();

            _ocrLabels = await JsRuntime.InvokeAsync<List<DetectedLabelDto>>("mapTools.scanMapText", _imageDataUrl);
            Console.WriteLine($"OCR Success: Found {_ocrLabels.Count} regions.");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Upload Error: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            _isScanning = false;
            StateHasChanged();
        }

        _shouldRenderMap = true;
    }

    private async Task HandleCanvasClick(MouseEventArgs e)
    {
        if (_selectedFaction == null) return;

        if (_currentTool == "PAINT")
        {
            var realCoords = await JsRuntime.InvokeAsync<PaintCoord>(
                "mapTools.floodFill",
                e.OffsetX,
                e.OffsetY,
                _selectedFaction.Color
            );

            if (realCoords != null)
            {
                var closestLabel = _ocrLabels
                    .Select(l => new
                    {
                        Label = l,
                        Distance = Math.Sqrt(Math.Pow(l.X - realCoords.X, 2) + Math.Pow(l.Y - realCoords.Y, 2))
                    })
                    .Where(x => x.Distance < 1500) 
                    .OrderBy(x => x.Distance)
                    .FirstOrDefault();

                _regionName = !string.IsNullOrWhiteSpace(closestLabel?.Label.Text) 
                    ? closestLabel.Label.Text 
                    : "UNKNOWN SECTOR";

                var nearbyExistingZone = _recordedZones
                    .FirstOrDefault(z => Math.Sqrt(Math.Pow(z.X - realCoords.X, 2) + Math.Pow(z.Y - realCoords.Y, 2)) < 40);

                if (nearbyExistingZone != null)
                {
                    nearbyExistingZone.FactionName = _selectedFaction.Name;
                    nearbyExistingZone.X = realCoords.X;
                    nearbyExistingZone.Y = realCoords.Y;
                    nearbyExistingZone.Name = _regionName;
                }
                else
                {
                    _recordedZones.Add(new ZoneSeedDto
                    {
                        X = realCoords.X,
                        Y = realCoords.Y,
                        FactionName = _selectedFaction.Name,
                        Name = _regionName
                    });
                }
            }
        }
        else if (_currentTool == "DEPLOY")
        {
            if (string.IsNullOrEmpty(_selectedDefinitionId) && _draggingUnit != null) return;

            _deployedUnits.Add(new UnitDto
            {
                DefinitionId = _selectedDefinitionId,
                FactionName = _selectedFaction.Name,
                X = e.OffsetX,
                Y = e.OffsetY
            });
        }
    }
    private async Task ResetMap()
    {
        await JsRuntime.InvokeVoidAsync("mapTools.resetMap");
    }

    private async Task SaveCampaign()
    {
        if (MissingRequirements.Any())
        {
            return;
        }

        var gameState = new GameStateDto
        {
            Factions = _model.Factions,
            Zones = _recordedZones,
            Units = _deployedUnits,
            UnitDefinitions = _unitDefinitions,
            CurrentTurnFaction = _startingFaction.Name,
            TurnNumber = 1
        };

        var jsonString = JsonSerializer.Serialize(gameState);

        using var content = new MultipartFormDataContent();
        content.Add(new StringContent(_model.Name), "Name");
        content.Add(new StringContent(jsonString), "GameStateJson");
        content.Add(new StringContent(_myFaction.Name), "CreatorFactionName");

        var imgContent = new ByteArrayContent(_fileBytes);
        imgContent.Headers.ContentType = new MediaTypeHeaderValue(_fileContentType);
        content.Add(imgContent, "MapImage", "map.png");

        var request = new HttpRequestMessage(HttpMethod.Post, "api/Campaign/create");
        request.Content = content;
        request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);
        var response = await Http.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            await _paper.TossAndNavigate("/home");
        }
        else
        {
            _errorMessage = "Deployment Failed. Check server logs.";
        }
    }

    private async Task HandleIconUnitUpload(InputFileChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(_unitName))
        {
            return;
        }

        var file = e.File;
        var resized = await file.RequestImageFileAsync("image/png", 64, 64);
        var buffer = new byte[resized.Size];
        await resized.OpenReadStream().ReadAsync(buffer);

        var base64 = Convert.ToBase64String(buffer);

        var newDef = new UnitDefinitionDto
        {
            Name = _unitName,
            ImageBase64 = $"data:image/png;base64,{base64}"
        };

        _unitDefinitions.Add(newDef);
        _selectedDefinitionId = newDef.Id;
        _unitName = string.Empty;
    }

    private void StartDrag(UnitDto unit)
    {
        if (_currentTool == "DEPLOY")
        {
            _draggingUnit = unit;
        }
    }

    private void HandleWrapperMouseMove(MouseEventArgs e)
    {
        if (_draggingUnit != null)
        {
            _draggingUnit.X = e.OffsetX;
            _draggingUnit.Y = e.OffsetY;
        }
    }

    private void HandleWrapperMouseUp(MouseEventArgs e)
    {
        _draggingUnit = null;
    }

    private void DeleteUnit(UnitDto unit)
    {
        if (_currentTool == "DEPLOY")
        {
            _deployedUnits.Remove(unit);
        }
    }

    private async void GoBack()
    {
        await _paper.TossAndNavigate("/home");
    }

    public class PaintCoord
    {
        public double X { get; set; }
        public double Y { get; set; }
    }

    private async Task AddFaction()
    {
        if (_factionName == String.Empty)
        {
            return;
        }

        var exists = _model.Factions.Any(t => t.Name == _factionName);
        if (exists)
        {
            return;
        }

        var newFaction = new FactionDto
        {
            Name = _factionName,
            Color = _factionColor
        };

        _model.Factions.Add(newFaction);

        _factionName = String.Empty;
        _factionColor = "#000000";

        if (_model.Factions.Count == 1)
        {
            _selectedFaction = newFaction;
        }

        StateHasChanged();
    }

}